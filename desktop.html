<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		
		<title>Tides - Desktop version</title>
		<style>
		</style>
		<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
		<script>
			var isMobile = Math.min(window.screen.width, window.screen.height) < 768 || navigator.userAgent.indexOf("Mobi") > -1;
			if (isMobile) {
				window.location.href = "index.html";
			}
		</script>
	</head>
	<body>
		<h1 class="title">
			Tides
			<select name="location" id="location" onchange="reload()">
				<option value="Aberdeen, Scotland">Aberdeen</option>
				<option value="Avonmouth, England">Avonmouth</option>
				<option value="Bangor, Northern Ireland">Bangor (NI)</option>
				<option value="Barmouth, Wales">Barmouth</option>
				<option value="Bournemouth, England">Bournemouth</option>
				<option value="Cromer, England">Cromer</option>
				<option value="Devonport, England">Devonport</option>
				<option value="Dover, England">Dover</option>
				<option value="Felixstowe, England">Felixstowe</option>
				<option value="Fishguard, Wales">Fishguard</option>
				<option value="Harwich, England">Harwich</option>
				<option value="Heysham, England">Heysham</option>
				<option value="Hinkley Point, England">Hinkley Point</option>
				<option value="Holyhead, Wales">Holyhead</option>
				<option value="Ilfracombe, England">Ilfracombe</option>
				<option value="Immingham, England">Immingham</option>
				<option value="Kinlochbervie, Scotland">Kinlochbervie</option>
				<option value="Leith, Scotland">Leith</option>
				<option value="Lerwick, Shetland Islands, Scotland">Lerwick</option>
				<option value="Liverpool (Gladstone Dock), England">Liverpool</option>
				<option selected="selected" value="Llandudno, Gwynedd, Wales">Llandudno</option>
				<option value="Lowestoft, England">Lowestoft</option>
				<option value="Milford Haven, Wales">Milford Haven</option>
				<option value="Millport, Scotland">Millport</option>
				<option value="Moray Firth (sheet pile wall), Scotland">Moray Firth</option>
				<option value="Mumbles, Wales">Mumbles</option>
				<option value="Newhaven, England">Newhaven</option>
				<option value="Newlyn, England">Newlyn</option>
				<option value="Newport, Gwent, Wales">Newport</option>
				<option value="Northshields, England">Northshields</option>
				<option value="Port Ellen, Islay, Western Scotland">Port Ellen</option>
				<option value="Port Erin, Isle of Man">Port Erin</option>
				<option value="Portpatrick, Scotland">Portpatrick</option>
				<option value="Portrush, Northern Ireland">Portrush</option>
				<option value="Portsmouth, England">Portsmouth</option>
				<option value="Sheerness, England">Sheerness</option>
				<option value="St. Helier, Jersey, Channel Islands">St. Helier</option>
				<option value="St. Mary's, Isles of Scilly, England">St. Mary's</option>
				<option value="Stornoway, Isle of Lewis, Scotland">Stornoway</option>
				<option value="Tobermory, Island of Mull, Scotland">Tobermory</option>
				<option value="Ullapool, Scotland">Ullapool</option>
				<option value="Weymouth, England">Weymouth</option>
				<option value="Whitby, England">Whitby</option>
				<option value="Wick, Scotland">Wick</option>
				<option value="Workington, England">Workington</option>
			</select>
			on
			<input type="date" id="timestamp" name="timestamp" onchange="reload()"/>
			for
			<select name="days" id="days" onchange="reload()">
				<option value="2">2 days</option>
				<option value="5">5 days</option>
				<option value="7">1 week</option>
				<option value="14">2 weeks</option>
				<option selected="selected" value="31">1 month</option>
				<option value="90">3 months</option>
				<option value="180">6 months</option>
				<option value="365">1 year</option>
			</select>
		</h1>
		<div id='myDiv'>
			
			<script>
				
				function reload() {
					
					
					// Set the date picker to default to today
					var timestampElem = document.getElementById('timestamp');
					var now = new Date();
					
					var minTimeLastTide = now;
					minTimeLastTide.setHours(minTimeLastTide.getHours() - 6); // take off 6 hours
					minTimeLastTide.setMinutes(0,0,0); // Sets minutes, seconds and milliseconds to zero
					console.log("6 hours ago rounded down to previous hour: " + minTimeLastTide);
					
					timestampElem.valueAsDate = minTimeLastTide; // Note time part gets stripped when saved in input type="date"
					
				}
				/*
					trace1 = {
					type: 'scatter',
					x: [1, 2, 3, 4],
					y: [10, 15, 13, 17],
					mode: 'lines',
					name: 'Red',
					line: {
					color: 'rgb(219, 64, 82)',
					width: 3,
					shape: 'spline'
					}
					};
					
					trace2 = {
					type: 'scatter',
					x: [1, 2, 3, 4],
					y: [12, 9, 15, 12],
					mode: 'lines',
					name: 'Blue',
					line: {
					color: 'rgb(55, 128, 191)',
					width: 1
					}
					};
					
					var layout = {
					width: 500,
					height: 500
					};
					
					var data = [trace1, trace2];
					
					Plotly.newPlot('myDiv', data, layout);
				*/
				function makeplot() {
					var timestamp = document.getElementById('timestamp');
					var loc = document.getElementById('location');
					var days = document.getElementById('days');
					
					Plotly.d3.csv("heights.php?format=csv&location=" + loc.value + "&timestamp=" + timestamp.value + "&days=" + days.value, function(data){ processData(data) } );
					
				};
				
				function processData(allRows) {
					
					console.log(allRows);
					var x = [], y = []; standard_deviation = [];
					
					for (var i=0; i<allRows.length; i++) {
						row = allRows[i];
						x.push( row['unix_time'] );
						y.push( row['height'] );
					}
					//console.log( 'X',x, 'Y',y, 'SD',standard_deviation );
					makePlotly( x, y, standard_deviation );
				}
				
				function makePlotly( x, y, standard_deviation ){
					var plotDiv = document.getElementById("plot");
					var traces = [{
						x: x, 
						y: y
					}];
					
					Plotly.newPlot('myDiv', traces, 
					{
						title: 'Tide', 
						displayModeBar: true
					}
					);
				};
				reload();
				makeplot();
				
			</script>
		</body>
	</html>
	
