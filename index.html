<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<link rel="apple-touch-icon" sizes="57x57" href="resources/apple-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="resources/apple-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="resources/apple-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="resources/apple-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="resources/apple-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="resources/apple-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="resources/apple-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="resources/apple-icon-152x152.png">
		<link rel="apple-touch-icon" sizes="180x180" href="resources/apple-icon-180x180.png">
		<link rel="icon" type="image/png" sizes="192x192"  href="resources/android-icon-192x192.png">
		<link rel="icon" type="image/png" sizes="32x32" href="resources/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="96x96" href="resources/favicon-96x96.png">
		<link rel="icon" type="image/png" sizes="16x16" href="resources/favicon-16x16.png">
		<link rel="manifest" href="resources/manifest.json">
		<meta name="msapplication-TileColor" content="#ffffff">
		<meta name="msapplication-TileImage" content="resources/ms-icon-144x144.png">
		<meta name="theme-color" content="#ffffff">
		
		<title>Tides</title>
		<style>
			.title, input, select {
				font-family: 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
				font-size: 2.5vh;
				font-style: normal;
				text-align: center;
				margin: 0 auto;
			}
			select {
				text-align: left;
			}
		</style>
		<script src="resources/chart.js"></script>
		<script src="resources/chartjs-adapter-date-fns.js"></script>
	</head>
	<body>
		<h1 class="title">
			No adverts, no fluff, just tides for
			<select name="location" id="location" onchange="reload()">
				<option value="Aberdeen, Scotland">Aberdeen</option>
				<option value="Avonmouth, England">Avonmouth</option>
				<option value="Bangor, Northern Ireland">Bangor (NI)</option>
				<option value="Barmouth, Wales">Barmouth</option>
				<option value="Bournemouth, England">Bournemouth</option>
				<option value="Cromer, England">Cromer</option>
				<option value="Devonport, England">Devonport</option>
				<option value="Dover, England">Dover</option>
				<option value="Felixstowe, England">Felixstowe</option>
				<option value="Fishguard, Wales">Fishguard</option>
				<option value="Harwich, England">Harwich</option>
				<option value="Heysham, England">Heysham</option>
				<option value="Hinkley Point, England">Hinkley Point</option>
				<option value="Holyhead, Wales">Holyhead</option>
				<option value="Ilfracombe, England">Ilfracombe</option>
				<option value="Immingham, England">Immingham</option>
				<option value="Kinlochbervie, Scotland">Kinlochbervie</option>
				<option value="Leith, Scotland">Leith</option>
				<option value="Lerwick, Shetland Islands, Scotland">Lerwick</option>
				<option value="Liverpool (Gladstone Dock), England">Liverpool</option>
				<option selected="selected" value="Llandudno, Gwynedd, Wales">Llandudno</option>
				<option value="Lowestoft, England">Lowestoft</option>
				<option value="Milford Haven, Wales">Milford Haven</option>
				<option value="Millport, Scotland">Millport</option>
				<option value="Moray Firth (sheet pile wall), Scotland">Moray Firth</option>
				<option value="Mumbles, Wales">Mumbles</option>
				<option value="Newhaven, England">Newhaven</option>
				<option value="Newlyn, England">Newlyn</option>
				<option value="Newport, Gwent, Wales">Newport</option>
				<option value="Northshields, England">Northshields</option>
				<option value="Port Ellen, Islay, Western Scotland">Port Ellen</option>
				<option value="Port Erin, Isle of Man">Port Erin</option>
				<option value="Portpatrick, Scotland">Portpatrick</option>
				<option value="Portrush, Northern Ireland">Portrush</option>
				<option value="Portsmouth, England">Portsmouth</option>
				<option value="Sheerness, England">Sheerness</option>
				<option value="St. Helier, Jersey, Channel Islands">St. Helier</option>
				<option value="St. Mary's, Isles of Scilly, England">St. Mary's</option>
				<option value="Stornoway, Isle of Lewis, Scotland">Stornoway</option>
				<option value="Tobermory, Island of Mull, Scotland">Tobermory</option>
				<option value="Ullapool, Scotland">Ullapool</option>
				<option value="Weymouth, England">Weymouth</option>
				<option value="Whitby, England">Whitby</option>
				<option value="Wick, Scotland">Wick</option>
				<option value="Workington, England">Workington</option>
			</select>
			on
			<input type="date" id="timestamp" name="timestamp" onchange="reload()"/>
		</h1>
		<div class="chart-container">
			<canvas id="tideChart"></canvas>
		</div>
		
		
		<script>
			
			function reload() {
				
				const minHeight = -0.5;
				const maxHeight = 8.5;
				
				var timestamp = document.getElementById('timestamp');
				var loc = document.getElementById('location');
				console.log("Reload called for location: " + loc.value + ", date: " + timestamp.value);
				fetch("heights.php?location=" + loc.value + "&timestamp=" + timestamp.value, {cache: "reload"})
				.then(response => response.json())
				.then(data => {
					// Create dataset
					const chartData = {
						labels: [],
						datasets: [{
							label: 'Tide Height',
							data: [], /* Tidal data filled in later from API */
							borderColor: 'rgb(75, 192, 192)',
							tension: 0.1
						},
						{
							type: 'line',
							data: [ /* Abusing a 2nd dataset to draw a vertical line at the current timestamp */
							{x: new Date(), y: minHeight - 1},
							{x: new Date(), y: maxHeight + 1}
							],
							borderColor: 'rgb(255,0,0)',
							
						}]
					};
					
					// Populate dataset from JSON
					data.forEach(item => {
						var date = new Date(item[0] * 1000); // Convert Unix timestamp to milliseconds
						chartData.labels.push(date);
						chartData.datasets[0].data.push({x: date, y: item[1]});
					});
					
					// Set chart options
					var options = {
						animation: false,
						responsive: true,
						maintainAspectRatio: false,
						
						plugins: {
							title: {
								display: false,
							},
							legend: {
								display: false
							}
						},
						scales: {
							x: {
								type: 'time',
								time: {
									round: 'minute',
									tooltipFormat: 'yyyy-MM-dd HH:mm',
									displayFormats: { /* force display formats at possible zoom levels */
										millisecond: 'HH:mm:ss',
										second: 'HH:mm:ss',
										minute: 'HH:mm',
										hour: 'HH:mm'
									}
								},
							},
							y: {
								min: minHeight,
								max: maxHeight,
								title: {
									display: true,
									text: 'Height (m) above chart datum'
								}
							},
						}
					};
					
					// Scale chart to viewport
					var chartCanvas = document.getElementById('tideChart'); //<canvas> id
					chartCanvas.width = window.innerWidth * 0.9;
					chartCanvas.height = window.innerHeight * 0.9;
					
					// Check if chart has been created previously. If so destroy it to make a new one
					let chartStatus = Chart.getChart("tideChart"); // <canvas> id
					if (chartStatus != undefined) {
					  chartStatus.destroy();
					}
					
					var chartInstance = new Chart(chartCanvas, {
						type: 'line',
						data: chartData,
						options: options
					});
					
				});
			}
			
			// Set the date picker to default to today
			var timestamp = document.getElementById('timestamp');
			timestamp.valueAsDate = new Date();
			
			reload();
		</script>
	</body>
</html>

